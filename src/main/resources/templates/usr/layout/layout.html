<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- 제이쿼리 불러오기 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- 폰트어썸 아이콘 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- toastr 불러오기 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js"></script>
    <link rel="stylesheet" href="https://jhs512.github.io/toastr/toastr.css">

    <!-- 공통 JS 불러오기 -->
    <script src="/resource/common/common.js"></script>

    <!-- 공통 CSS 불러오기 -->
    <link rel="stylesheet" href="/resource/common/common.css">

    <!-- 데이지 UI 불러오기 -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@2.51.5/dist/full.css" rel="stylesheet" type="text/css"/>

    <!-- 테일윈드 불러오기 -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"
          type="text/css"/>

    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-messaging.js"></script>
</head>

<body>

<main class="min-h-screen flex flex-col">
    <header class="sticky top-0">
        <div class="navbar max-w-2xl mx-auto bg-base-100">

            <!-- 목록 드롭다운 시작 -->
            <div class="navbar-start">
                <div class="dropdown">

                    <!-- 목록 아이콘 -->
                    <label tabindex="0" class="btn btn-ghost btn-circle focus:outline-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M4 6h16M4 12h16M4 18h7"/>
                        </svg>
                    </label>

                    <!-- 드롭다운 -->
                    <ul tabindex="0"
                        class="menu menu-compact dropdown-content mt-3 p-2 shadow bg-base-100 rounded-box w-52">
                        <li th:if="${@rq.logout}" class="flex justify-between">
                            <a href="/member/login"><i class="fa-solid fa-arrow-right-to-bracket"></i>로그인</a>
                        </li>
                        <li th:if="${@rq.login}">
                            <a href="javascript:" onclick="$(this).next().submit();">
                                <i class="fa-solid fa-arrow-right-from-bracket"></i> 로그아웃
                            </a>
                            <form class="!hidden" method="POST" th:action="|/member/logout|"></form>
                        </li>
                        <li><a href="/wishlist" style="color: black;">관심있는 공구 목록</a></li>
                        <li><a href="/myItems" style="color: black;">나의 상품 목록</a></li>
                        <li><a href="/store" style="color: black;">스토어</a></li>
                        <li><a href="/upload" style="color: black;">이미지 업로드</a></li>
                    </ul>
                </div>
            </div>
            <!-- 목록 드롭다운 끝 -->

            <!-- 로고 시작 -->
            <div class="con mx-auto pr-3 h-full center">
                <a href="/" class="logo text-lg font-bold flex items-center px-3">
                    Gong9ri
                </a>
            </div>
            <!-- 로고 끝 -->

            <!-- 알림 시작 -->
            <div class="navbar-end">
                <a id="openModalButton1" class="btn btn-ghost btn-circle" th:if="${@rq.login}">
                    <!--                    <div class="indicator" style="position: relative;">-->
                    <!--                        <i class="fa-regular fa-bell">-->
                    <!--                            <span data-test="hasUnreadNotifications" th:if="${@rq.hasUnreadNotifications()}"-->
                    <!--                                  class="badge badge-xs badge-secondary indicator-item"-->
                    <!--                                  style="position: absolute; top: -5px; right: -5px;">-->
                    <!--                            </span>-->
                    <!--                        </i>-->
                    <!--                    </div>-->
                </a>
            </div>
            <!-- 알림 끝 -->

        </div>
    </header>

    <main layout:fragment="main"></main>

    <script th:inline="javascript" type="module">


        let firebaseConfig = {
            apiKey: "AIzaSyDLKx_5B8kBCu8QPxLzYsrA9lpXnjdBPB8",
            authDomain: "gong9ri-e7e80.firebaseapp.com",
            projectId: "gong9ri-e7e80",
            storageBucket: "gong9ri-e7e80.appspot.com",
            messagingSenderId: "102830193096",
            appId: "1:102830193096:web:21465d3f428ef17372e8fd",
            measurementId: "G-RVC0TV1BBY"
        };

        async function requestNotificationPermission(config) {
            firebase.initializeApp(config);

            const messaging = firebase.messaging();

            try {
                await Notification.requestPermission();

                if (Notification.permission === "granted") {
                    console.log("Notification permission granted.");
                    messaging.getToken().then((currentToken) => {
                        if (currentToken) {
                            submitToken(currentToken);
                            console.log("Token: ", currentToken);
                        } else {
                            console.warn("No Instance ID token available. Request permission to generate one.");
                        }
                    }).catch((err) => {
                        console.warn("An error occurred while retrieving token. ", err);
                    });

                    messaging.onMessage((payload) => {
                        console.log("Message received. ", payload);
                    });

                    messaging.onTokenRefresh(() => {
                        messaging.getToken().then((refreshedToken) => {
                            console.log("Token refreshed.", refreshedToken);
                        }).catch((err) => {
                            console.warn("Unable to retrieve refreshed token ", err);
                        });
                    });
                } else {
                    console.warn("Unable to get permission to notify.");
                }
            } catch (error) {
                console.error("Error in requestNotificationPermission: ", error);
            }
        }

        requestNotificationPermission(firebaseConfig);

        function submitToken(token) {
            const url = '/v1/tokens';
            const requestOptions = {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({tokenString: token})
            };

            fetch(url, requestOptions)
                .then((response) => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw new Error('Error while submitting token. Status code: ' + response.status);
                    }
                })
                .then((resultCode) => {
                    console.log('Success! Result code:', resultCode);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
    </script>

</main>

</body>
</html>